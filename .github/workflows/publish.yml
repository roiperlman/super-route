name: Build and publish package
on:
  push:
    branches: [ master ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [ '14', '15', '16' ]
    steps:
      - uses: actions/checkout@v2
      - name: Setup node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}
      - run: |
          npm install
          npm install -g typescript
      - name: build
        id: build
        run: tsc

########## TEST ##########
  test:
    needs: [build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [ '14', '15', '16' ]
    steps:
      - uses: actions/checkout@v2
      - name: Setup node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}
      - run: |
          npm install
          npm install -g typescript mocha ts-node
      - name: Run Tests
        id: test
        run: npm run test
#      - name: Run Coveralls
#        run: npm run coveralls
#      - name: Publish results to codecov
#        uses: codecov/codecov-action@v2
#        with:
#          verbose: true


########## PUBLISH ##########
  publish:
    needs: [ build, test ]
    runs-on: ubuntu-latest
    outputs:
      update_type: ${{ steps.publish.outputs.type }}
      new_version: ${{ steps.publish.outputs.version }}
    steps:
      - uses: actions/checkout@v2
      - name: Setup node
        uses: actions/setup-node@v2
        with:
          node-version: 16.x
      - run: |
          npm install
          npm install -g typescript mocha ts-node
      - name: Build
        run: tsc
      - name: publish
        id: publish
        uses: JS-DevTools/npm-publish@v1
        with:
          token: ${{ secrets.NPM_TOKEN }}
          check-version: true
      - if: steps.publish.outputs.type != 'none'
        run: |
          echo "Version changed: ${{ steps.publish.outputs.old-version }} => ${{ steps.publish.outputs.version }}"

  send_report:
    if: always()
    needs: [ build, test, publish ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Private actions checkout
        uses: daspn/private-actions-checkout@v2
        with:
          actions_list: '["roiperlman/telegram_notifier@master"]'
          checkout_base_path: ./.github/actions/external
          app_id: ${{ secrets.APP_ID }}
          app_private_key: ${{ secrets.APP_PRIVATE_KEY }}
          configure_git: true
      - name: notify
        uses: ./.github/actions/external/telegram_notifier/.github/actions/notifier
        with:
          message: >
            Workflow Execution Summary:

            📂 Repository: ${{ github.event.repository.name }}

            🔧 Workflow: ${{ github.workflow }}

            ❗ Status: ${{ job.status }}

            Jobs Status:
              ▪️ Build: ${{ needs.build.result }}
              ▪️ Test: ${{ needs.test.result }}
              ▪️ Publish: ${{ needs.publish.result }}
                    New Version: ${{ needs.publish.outputs.new_version }}
                    Update Type: ${{ needs.publish.outputs.update_type }}






